<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><h1 dir="auto"><a id="user-content-bazel-build-rules-for-gnu-m4" class="anchor" aria-hidden="true" tabindex="-1" href="#bazel-build-rules-for-gnu-m4"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Bazel build rules for GNU M4</h1>
<p dir="auto">The <a href="https://en.wikipedia.org/wiki/M4_(computer_language)" rel="nofollow">m4</a> macro processing language is commonly used as an intermediate format
for text-based Unix development tools such as <a href="https://www.gnu.org/software/bison/" rel="nofollow">Bison</a> and <a href="https://github.com/westes/flex">Flex</a>.</p>
<p dir="auto">This Bazel ruleset allows <a href="https://www.gnu.org/software/m4/" rel="nofollow">GNU M4</a> to be integrated into a Bazel build. It can
be used to perform macro expansion with the <code>//m4:m4.bzl%m4</code> build rule, or as
a dependency in other rules via the Bazel toolchain system.</p>
<p dir="auto">Currently, the only implementation of m4 supported by this ruleset is <a href="https://www.gnu.org/software/m4/" rel="nofollow">GNU M4</a>.</p>
<p dir="auto">API reference: <a href="docs/rules_m4.md">docs/rules_m4.md</a></p>
<h2 dir="auto"><a id="user-content-setup" class="anchor" aria-hidden="true" tabindex="-1" href="#setup"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Setup</h2>
<h3 dir="auto"><a id="user-content-as-a-module-dependency-bzlmod" class="anchor" aria-hidden="true" tabindex="-1" href="#as-a-module-dependency-bzlmod"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>As a module dependency (bzlmod)</h3>
<p dir="auto">Add the following to your <code>MODULE.bazel</code>:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="bazel_dep(name = &quot;rules_m4&quot;, version = &quot;0.2.3&quot;)"><pre lang="python" class="notranslate"><code>bazel_dep(name = "rules_m4", version = "0.2.3")
</code></pre></div>
<p dir="auto">To specify a version or build with additional C compiler options, use the
<code>m4_repository_ext</code> module extension:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="m4 = use_extension(
    &quot;@rules_m4//m4/extensions:m4_repository_ext.bzl&quot;,
    &quot;m4_repository_ext&quot;,
)
m4.repository(
    name = &quot;m4&quot;,
    version = &quot;1.4.17&quot;,
    extra_copts = [&quot;-O3&quot;],
)
use_repo(m4, &quot;m4&quot;)
register_toolchains(&quot;@m4//:toolchain&quot;)"><pre lang="python" class="notranslate"><code>m4 = use_extension(
    "@rules_m4//m4/extensions:m4_repository_ext.bzl",
    "m4_repository_ext",
)
m4.repository(
    name = "m4",
    version = "1.4.17",
    extra_copts = ["-O3"],
)
use_repo(m4, "m4")
register_toolchains("@m4//:toolchain")
</code></pre></div>
<p dir="auto">Note that repository names registered with a given bzlmod module extension must be unique within the scope of that extension. See the <a href="https://bazel.build/external/extension" rel="nofollow">Bazel module extensions</a>
documentation for more details.</p>
<h3 dir="auto"><a id="user-content-as-a-workspace-dependency" class="anchor" aria-hidden="true" tabindex="-1" href="#as-a-workspace-dependency"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>As a workspace dependency</h3>
<p dir="auto">Add the following to your <code>WORKSPACE.bazel</code>:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="load(&quot;@bazel_tools//tools/build_defs/repo:http.bzl&quot;, &quot;http_archive&quot;)

http_archive(
    name = &quot;rules_m4&quot;,
    # Obtain the package checksum from the release page:
    # https://github.com/jmillikin/rules_m4/releases/tag/v0.2.3
    sha256 = &quot;&quot;,
    urls = [&quot;https://github.com/jmillikin/rules_m4/releases/download/v0.2.3/rules_m4-v0.2.3.tar.xz&quot;],
)

load(&quot;@rules_m4//m4:m4.bzl&quot;, &quot;m4_register_toolchains&quot;)

m4_register_toolchains(version = &quot;1.4.18&quot;)"><pre lang="python" class="notranslate"><code>load("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")

http_archive(
    name = "rules_m4",
    # Obtain the package checksum from the release page:
    # https://github.com/jmillikin/rules_m4/releases/tag/v0.2.3
    sha256 = "",
    urls = ["https://github.com/jmillikin/rules_m4/releases/download/v0.2.3/rules_m4-v0.2.3.tar.xz"],
)

load("@rules_m4//m4:m4.bzl", "m4_register_toolchains")

m4_register_toolchains(version = "1.4.18")
</code></pre></div>
<p dir="auto">To specify a version or build with additional C compiler options, use the
<code>m4_repository</code> and <code>m4_toolchain_repository</code> repository rules:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="load(&quot;@rules_m4//m4:m4.bzl&quot;, &quot;m4_repository&quot;, &quot;m4_toolchain_repository&quot;)

m4_repository(
    name = &quot;m4_v1.4.17_fast&quot;,
    version = &quot;1.4.17&quot;,
    extra_copts = [&quot;-O3&quot;],
)

m4_toolchain_repository(
    name = &quot;m4_toolchain_v1.4.17_fast&quot;,
    m4_repository = &quot;@m4_v1.4.17_fast&quot;,
)

register_toolchains(&quot;@m4_toolchain_v1.4.17_fast//:toolchain&quot;)"><pre lang="python" class="notranslate"><code>load("@rules_m4//m4:m4.bzl", "m4_repository", "m4_toolchain_repository")

m4_repository(
    name = "m4_v1.4.17_fast",
    version = "1.4.17",
    extra_copts = ["-O3"],
)

m4_toolchain_repository(
    name = "m4_toolchain_v1.4.17_fast",
    m4_repository = "@m4_v1.4.17_fast",
)

register_toolchains("@m4_toolchain_v1.4.17_fast//:toolchain")
</code></pre></div>
<h2 dir="auto"><a id="user-content-examples" class="anchor" aria-hidden="true" tabindex="-1" href="#examples"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a>Examples</h2>
<p dir="auto">Macro expansion with the <code>//m4:m4.bzl%m4</code> build rule:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="load(&quot;@rules_m4//m4:m4.bzl&quot;, &quot;m4&quot;)

m4(
    name = &quot;hello_world&quot;,
    srcs = [&quot;hello_world.in.txt&quot;],
    output = &quot;hello_world.txt&quot;,
)"><pre lang="python" class="notranslate"><code>load("@rules_m4//m4:m4.bzl", "m4")

m4(
    name = "hello_world",
    srcs = ["hello_world.in.txt"],
    output = "hello_world.txt",
)
</code></pre></div>
<p dir="auto">Macro expansion in a <code>genrule</code>:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="genrule(
    name = &quot;hello_world_gen&quot;,
    srcs = [&quot;hello_world.in.txt&quot;],
    outs = [&quot;hello_world_gen.txt&quot;],
    cmd = &quot;$(M4) $(SRCS) &gt; $@&quot;,
    toolchains = [&quot;@rules_m4//m4:current_m4_toolchain&quot;],
)"><pre lang="python" class="notranslate"><code>genrule(
    name = "hello_world_gen",
    srcs = ["hello_world.in.txt"],
    outs = ["hello_world_gen.txt"],
    cmd = "$(M4) $(SRCS) &gt; $@",
    toolchains = ["@rules_m4//m4:current_m4_toolchain"],
)
</code></pre></div>
<p dir="auto">Writing a custom rule that depends on <code>m4</code> as a toolchain:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="load(&quot;@rules_m4//m4:m4.bzl&quot;, &quot;M4_TOOLCHAIN_TYPE&quot;, &quot;m4_toolchain&quot;)

def _my_rule(ctx):
    m4 = m4_toolchain(ctx)
    ctx.actions.run(
        tools = [m4.m4_tool],
        env = m4.m4_env,
        # ...
    )

my_rule = rule(
    implementation = _my_rule,
    toolchains = [M4_TOOLCHAIN_TYPE],
)"><pre lang="python" class="notranslate"><code>load("@rules_m4//m4:m4.bzl", "M4_TOOLCHAIN_TYPE", "m4_toolchain")

def _my_rule(ctx):
    m4 = m4_toolchain(ctx)
    ctx.actions.run(
        tools = [m4.m4_tool],
        env = m4.m4_env,
        # ...
    )

my_rule = rule(
    implementation = _my_rule,
    toolchains = [M4_TOOLCHAIN_TYPE],
)
</code></pre></div>
</article></div>