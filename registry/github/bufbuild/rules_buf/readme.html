<div id="readme" class="md" data-path="README.md"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">rules_buf</h1><a id="user-content-rules_buf" class="anchor-element" aria-label="Permalink: rules_buf" href="#rules_buf"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Bazel rules for <a href="https://buf.build/" rel="nofollow">Buf</a>. The rules work alongside the <code>proto_library</code> rule of <a href="https://github.com/bazelbuild/rules_proto">rules_proto</a>.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Status</h2><a id="user-content-status" class="anchor-element" aria-label="Permalink: Status" href="#status"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">This module is a beta, but we may make a few changes as we gather feedback from early adopters.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Setup</h2><a id="user-content-setup" class="anchor-element" aria-label="Permalink: Setup" href="#setup"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Include the following snippet in the Workspace file to setup <code>rules_buf</code>. Refer to <a href="https://github.com/bufbuild/rules_buf/releases">release notes</a> of a specific version for setup instructions.</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="load(&quot;@bazel_tools//tools/build_defs/repo:http.bzl&quot;, &quot;http_archive&quot;)

http_archive(
    name = &quot;rules_buf&quot;,
    sha256 = &quot;523a4e06f0746661e092d083757263a249fedca535bd6dd819a8c50de074731a&quot;,
    strip_prefix = &quot;rules_buf-0.1.1&quot;,
    urls = [
        &quot;https://github.com/bufbuild/rules_buf/archive/refs/tags/v0.1.1.zip&quot;,
    ],
)

load(&quot;@rules_buf//buf:repositories.bzl&quot;, &quot;rules_buf_dependencies&quot;, &quot;rules_buf_toolchains&quot;)

rules_buf_dependencies()

rules_buf_toolchains(version = &quot;v1.5.0&quot;)

# rules_proto
load(&quot;@rules_proto//proto:repositories.bzl&quot;, &quot;rules_proto_dependencies&quot;, &quot;rules_proto_toolchains&quot;)

rules_proto_dependencies()

rules_proto_toolchains()"><pre><span class="pl-en">load</span>(<span class="pl-s">"@bazel_tools//tools/build_defs/repo:http.bzl"</span>, <span class="pl-s">"http_archive"</span>)

<span class="pl-en">http_archive</span>(
    <span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"rules_buf"</span>,
    <span class="pl-s1">sha256</span> <span class="pl-c1">=</span> <span class="pl-s">"523a4e06f0746661e092d083757263a249fedca535bd6dd819a8c50de074731a"</span>,
    <span class="pl-s1">strip_prefix</span> <span class="pl-c1">=</span> <span class="pl-s">"rules_buf-0.1.1"</span>,
    <span class="pl-s1">urls</span> <span class="pl-c1">=</span> [
        <span class="pl-s">"https://github.com/bufbuild/rules_buf/archive/refs/tags/v0.1.1.zip"</span>,
    ],
)

<span class="pl-en">load</span>(<span class="pl-s">"@rules_buf//buf:repositories.bzl"</span>, <span class="pl-s">"rules_buf_dependencies"</span>, <span class="pl-s">"rules_buf_toolchains"</span>)

<span class="pl-en">rules_buf_dependencies</span>()

<span class="pl-en">rules_buf_toolchains</span>(<span class="pl-s1">version</span> <span class="pl-c1">=</span> <span class="pl-s">"v1.5.0"</span>)

<span class="pl-c"># rules_proto</span>
<span class="pl-en">load</span>(<span class="pl-s">"@rules_proto//proto:repositories.bzl"</span>, <span class="pl-s">"rules_proto_dependencies"</span>, <span class="pl-s">"rules_proto_toolchains"</span>)

<span class="pl-en">rules_proto_dependencies</span>()

<span class="pl-en">rules_proto_toolchains</span>()</pre></div>
<p dir="auto">Refer the <a href="https://docs.buf.build/build-systems/bazel" rel="nofollow">docs</a> or browse the <a href="examples">examples</a> on how to setup and use for various scenarios.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">List of rules</h2><a id="user-content-list-of-rules" class="anchor-element" aria-label="Permalink: List of rules" href="#list-of-rules"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<ul dir="auto">
<li><a href="https://docs.buf.build/build-systems/bazel#buf-dependencies" rel="nofollow">buf_dependencies</a></li>
<li><a href="https://docs.buf.build/build-systems/bazel#buf-lint-test" rel="nofollow">buf_lint_test</a></li>
<li><a href="https://docs.buf.build/build-systems/bazel#buf-breaking-test" rel="nofollow">buf_breaking_test</a></li>
</ul>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Gazelle Extension</h2><a id="user-content-gazelle-extension" class="anchor-element" aria-label="Permalink: Gazelle Extension" href="#gazelle-extension"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The repo also offers a Gazelle extension for generating the rules.</p>
<p dir="auto">Please refer to the <a href="https://docs.buf.build/build-systems/bazel#gazelle" rel="nofollow">gazelle section</a> in the docs.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Development</h2><a id="user-content-development" class="anchor-element" aria-label="Permalink: Development" href="#development"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">The repository follows the <a href="https://bazel.build/rules/deploying" rel="nofollow">official recommendation</a> on deploying bazel rules.
All the rule definitions are in <a href="buf/internal">buf/internal</a>.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Gazelle</h3><a id="user-content-gazelle" class="anchor-element" aria-label="Permalink: Gazelle" href="#gazelle"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Gazelle extension is in <a href="gazelle/buf">gazelle/buf</a>. Before looking at the code it would be best to understand the <a href="https://github.com/bazelbuild/bazel-gazelle/blob/master/Design.rst">architecture of gazelle</a>. The file structure is loosely based on the <code>go</code> and <code>proto</code> <a href="https://github.com/bazelbuild/bazel-gazelle/tree/master/language">extensions</a> that are shipped with gazelle.
They are also excellent to better understand the architecture.</p>
<p dir="auto">The main entry point to the extension is via the <code>NewLanguage</code> function in <a href="gazelle/buf/buf.go">gazelle/buf/buf.go</a>. Gazelle mostly depends on <a href="https://pkg.go.dev/github.com/bazelbuild/bazel-gazelle@v0.25.0/language#Language" rel="nofollow"><code>Language</code></a> interface. Apart from that one can also implement some optional interfaces.</p>
<p dir="auto">We implement the following interfaces,</p>
<ul dir="auto">
<li><a href="https://pkg.go.dev/github.com/bazelbuild/bazel-gazelle@v0.25.0/language#Language" rel="nofollow"><code>Language</code></a>: Required. Used for build/test rule generation and label resolutions for these rules.</li>
<li><a href="https://pkg.go.dev/github.com/bazelbuild/bazel-gazelle@v0.25.0/language#RepoImporter" rel="nofollow"><code>RepoImporter</code></a>: Optional. Used to generate <code>buf_dependencies</code> rule from <code>buf.yaml</code>/<code>buf.work.yaml</code>.</li>
<li><a href="https://pkg.go.dev/github.com/bazelbuild/bazel-gazelle@v0.25.0/resolve#CrossResolver" rel="nofollow"><code>CrossResolver</code></a>: Optional. Used to resolve dependencies across extensions/languages. We use it to resolve any proto files that are part of <code>buf_dependencies</code> rules.</li>
</ul>
</article></div>