<div id="readme" class="md" data-path="readme.md"><article class="markdown-body entry-content container-lg" itemprop="text"><div class="markdown-heading" dir="auto"><h1 class="heading-element" dir="auto">rules_multitool</h1><a id="user-content-rules_multitool" class="anchor" aria-label="Permalink: rules_multitool" href="#rules_multitool"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">An ergonomic approach to defining a single tool target that resolves to a matching os and CPU architecture variant of the tool.</p>
<div class="markdown-heading" dir="auto"><h2 class="heading-element" dir="auto">Usage</h2><a id="user-content-usage" class="anchor" aria-label="Permalink: Usage" href="#usage"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">For a quickstart, see the <a href="examples/module/">module example</a> or <a href="examples/workspace/">workspace example</a>.</p>
<p dir="auto">Define a <a href="lockfile.schema.json">lockfile</a> that references the tools to load:</p>
<div class="highlight highlight-source-json notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="{
  &quot;$schema&quot;: &quot;https://raw.githubusercontent.com/theoremlp/rules_multitool/main/lockfile.schema.json&quot;,
  &quot;tool-name&quot;: {
    &quot;binaries&quot;: [
      {
        &quot;kind&quot;: &quot;file&quot;,
        &quot;url&quot;: &quot;https://...&quot;,
        &quot;sha256&quot;: &quot;sha256 of the file&quot;,
        &quot;os&quot;: &quot;linux|macos&quot;,
        &quot;cpu&quot;: &quot;x86_64|arm64&quot;
      }
    ]
  }
}"><pre>{
  <span class="pl-ent">"$schema"</span>: <span class="pl-s"><span class="pl-pds">"</span>https://raw.githubusercontent.com/theoremlp/rules_multitool/main/lockfile.schema.json<span class="pl-pds">"</span></span>,
  <span class="pl-ent">"tool-name"</span>: {
    <span class="pl-ent">"binaries"</span>: [
      {
        <span class="pl-ent">"kind"</span>: <span class="pl-s"><span class="pl-pds">"</span>file<span class="pl-pds">"</span></span>,
        <span class="pl-ent">"url"</span>: <span class="pl-s"><span class="pl-pds">"</span>https://...<span class="pl-pds">"</span></span>,
        <span class="pl-ent">"sha256"</span>: <span class="pl-s"><span class="pl-pds">"</span>sha256 of the file<span class="pl-pds">"</span></span>,
        <span class="pl-ent">"os"</span>: <span class="pl-s"><span class="pl-pds">"</span>linux|macos<span class="pl-pds">"</span></span>,
        <span class="pl-ent">"cpu"</span>: <span class="pl-s"><span class="pl-pds">"</span>x86_64|arm64<span class="pl-pds">"</span></span>
      }
    ]
  }
}</pre></div>
<p dir="auto">The lockfile supports the following binary kinds:</p>
<ul dir="auto">
<li>
<p dir="auto"><strong>file</strong>: the URL refers to a file to download</p>
<ul dir="auto">
<li><code>sha256</code>: the sha256 of the downloaded file</li>
</ul>
</li>
<li>
<p dir="auto"><strong>archive</strong>: the URL referes to an archive to download, specify additional options:</p>
<ul dir="auto">
<li><code>file</code>: executable file within the archive</li>
<li><code>sha256</code>: the sha256 of the downloaded archive</li>
</ul>
</li>
<li>
<p dir="auto"><strong>pkg</strong>: the URL refers to a MacOS pkg archive to download, specify additional options:</p>
<ul dir="auto">
<li><code>file</code>: executable file within the archive</li>
<li><code>sha256</code>: the sha256 of the downloaded pkg archive</li>
</ul>
</li>
</ul>
<p dir="auto">Save your lockfile and ensure the file is exported using <code>export_files</code> so that it's available to Bazel.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Bazel Module Usage</h3><a id="user-content-bazel-module-usage" class="anchor" aria-label="Permalink: Bazel Module Usage" href="#bazel-module-usage"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Once your lockfile is defined, load the ruleset in your MODULE.bazel and create a hub that refers to your lockfile:</p>
<div class="highlight highlight-source-python notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="bazel_dep(name = &quot;rules_multitool&quot;, version = &quot;0.0.0&quot;)

multitool = use_extension(&quot;@rules_multitool//multitool:extension.bzl&quot;, &quot;multitool&quot;)
multitool.hub(lockfile = &quot;//:multitool.lock.json&quot;)
use_repo(multitool, &quot;multitool&quot;)"><pre><span class="pl-en">bazel_dep</span>(<span class="pl-s1">name</span> <span class="pl-c1">=</span> <span class="pl-s">"rules_multitool"</span>, <span class="pl-s1">version</span> <span class="pl-c1">=</span> <span class="pl-s">"0.0.0"</span>)

<span class="pl-s1">multitool</span> <span class="pl-c1">=</span> <span class="pl-en">use_extension</span>(<span class="pl-s">"@rules_multitool//multitool:extension.bzl"</span>, <span class="pl-s">"multitool"</span>)
<span class="pl-s1">multitool</span>.<span class="pl-en">hub</span>(<span class="pl-s1">lockfile</span> <span class="pl-c1">=</span> <span class="pl-s">"//:multitool.lock.json"</span>)
<span class="pl-en">use_repo</span>(<span class="pl-s1">multitool</span>, <span class="pl-s">"multitool"</span>)</pre></div>
<p dir="auto">Tools may then be accessed using <code>@multitool//tools/tool-name</code>.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Workspace Usage</h3><a id="user-content-workspace-usage" class="anchor" aria-label="Permalink: Workspace Usage" href="#workspace-usage"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">Instructions for using with WORKSPACE may be found in <a href="https://github.com/theoremlp/rules_multitool/releases">release notes</a>.</p>
<div class="markdown-heading" dir="auto"><h3 class="heading-element" dir="auto">Creating convenience scripts</h3><a id="user-content-creating-convenience-scripts" class="anchor" aria-label="Permalink: Creating convenience scripts" href="#creating-convenience-scripts"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5 0 1 1 4.95 4.95l-2.5 2.5a3.5 3.5 0 0 1-4.95 0 .751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018 1.998 1.998 0 0 0 2.83 0l2.5-2.5a2.002 2.002 0 0 0-2.83-2.83l-1.25 1.25a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042Zm-4.69 9.64a1.998 1.998 0 0 0 2.83 0l1.25-1.25a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042l-1.25 1.25a3.5 3.5 0 1 1-4.95-4.95l2.5-2.5a3.5 3.5 0 0 1 4.95 0 .751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018 1.998 1.998 0 0 0-2.83 0l-2.5 2.5a1.998 1.998 0 0 0 0 2.83Z"></path></svg></a></div>
<p dir="auto">When users need to execute tools directly, Bazel does not provide very good support for this,
because it sets the working directory to the root of the runfiles tree, which breaks the ability of the tool to resolve configuration files and other relative paths.</p>
<p dir="auto">The typical workarounds are all bad:</p>
<ol dir="auto">
<li>Change all paths the tool interacts with to be absolute, so that the working directory is inconsequential.</li>
<li>Wrap the tool in a trivial <code>sh_binary</code> that can read <code>$BUILD_WORKING_DIRECTORY</code>.</li>
<li>Use <code>--run_under="cd $PWD &amp;&amp;</code> however this <a href="https://github.com/bazelbuild/bazel/issues/10782" data-hovercard-type="issue" data-hovercard-url="/bazelbuild/bazel/issues/10782/hovercard">discards the analysis cache</a> slowing down this and the subsequent build.</li>
</ol>
<p dir="auto">Instead, the authors recommend the following technique. Create a script like <code>tools/_multitool_run_under_cwd.sh</code> containing the following shell code:</p>
<div class="highlight highlight-source-shell notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="#!/bin/bash
# Workaround https://github.com/bazelbuild/bazel/issues/3325
target=&quot;@multitool//tools/$(basename &quot;$0&quot;)&quot;
bazel build &quot;$target&quot; &amp;&amp; exec $(bazel 2&gt;/dev/null cquery --output=files &quot;$target&quot;) &quot;$@&quot;"><pre><span class="pl-c"><span class="pl-c">#!</span>/bin/bash</span>
<span class="pl-c"><span class="pl-c">#</span> Workaround https://github.com/bazelbuild/bazel/issues/3325</span>
target=<span class="pl-s"><span class="pl-pds">"</span>@multitool//tools/<span class="pl-s"><span class="pl-pds">$(</span>basename <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">$0</span><span class="pl-pds">"</span></span><span class="pl-pds">)</span></span><span class="pl-pds">"</span></span>
bazel build <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">$target</span><span class="pl-pds">"</span></span> <span class="pl-k">&amp;&amp;</span> <span class="pl-c1">exec</span> <span class="pl-s"><span class="pl-pds">$(</span>bazel <span class="pl-k">2&gt;</span>/dev/null cquery --output=files <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">$target</span><span class="pl-pds">"</span></span><span class="pl-pds">)</span></span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">$@</span><span class="pl-pds">"</span></span></pre></div>
<p dir="auto">Now just create symlinks such as <code>tools/mytool -&gt; ./_multitool_run_under_cwd.sh</code>.
This will build <code>@multitool//tools/mytool</code> and then execute the resulting binary in the current working directory.</p>
<p dir="auto">Developers can now just naively run <code>./tools/mytool --arg my/file</code> and don't need to worry about where the tool comes from.</p>
</article></div>